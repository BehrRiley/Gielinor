# Helper command for injecting NPC internals from chat commands
# Uses the command "[ Removed ]" - you can consider this a password.
# Nobody should run this command from in-game.
# Using the event ensures players do not know of the command via tab-complete or /help

# ████████████████████████████████████████████████████
# ██   Procedure
# ██   Used for all dialog procedures with NPC's
# ██   
# ██   

# ███ [ Chat Procedures      ] ███
silent_injector:
  type: world
  debug: false
  pw: "[ Removed ]"
  events:
    on [ Removed ] command:
    - if <c.args.size> != 4:
      - queue clear

    - determine passively fulfilled
    - if !<player.has_flag[sig]> || <player.flag[sig]> != <c.args.get[4]>:
      - queue clear

    - run <c.args.get[1]> path:<c.args.get[2]> instantly npc:<c.args.get[3]>

# ███ [ Chat Procedures      ] ███
option:
  type: procedure
  definitions: display|path|npc|sig|interact
  debug: false
  script:
  - define c_text "<&6>[<&e>Click<&6>]<&r> <def[display]>"
  - define s_text "<&6>[<&e>Select Option<&6>]<&r> <def[display]>"
  - determine "<proc[msgCommand].context[<def[c_text]>|<s@silent_injector.yaml_key[pw]> <def[interact]> <def[path]> <def[npc]> <def[sig]>|<def[s_text]>]>"

# ███ [ Chat Injector Helper ] ███
opt_loop:
  type: task
  definitions: Script|NPC|Path
  debug: false
  script:
  - define sig <util.random.uuid>
  - flag player sig:<def[sig]>
  - foreach <s@<def[Script]>.yaml_key[Path]>:
  #- foreach <script.yaml_key[<def[1]>]>:
    - define value <def[value].split[/].limit[2]>
    - define interacting <player.flag[interacting_npc]>
    - narrate "<proc[option].context[<parse:<def[value].get[2]>>|<def[value].get[Path]>|<npc||<def[NPC]>>|<def[sig]>|<def[interacting]>]>"
  test:
  - narrate "<&6>[<&e><def[Script]><&6>] [<&e><def[NPC]><&6>] [<&e><def[Path]><&6>]"
